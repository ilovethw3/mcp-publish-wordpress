# 需求文档：MCP WordPress 发布服务器 v2.1 - API 密钥认证增强

## 1. 简介

MCP WordPress Publisher Server v2.1 版本专注于解决当前系统中的关键安全问题。经过安全分析发现，现有的 v2.0 系统在 Agent 与 MCP 服务器之间的连接缺乏有效的身份认证机制，特别是在 SSE（Server-Sent Events）传输模式下，存在严重的安全漏洞。

本版本将实现完整的 API 密钥认证体系，确保只有经过授权的 AI 智能体才能访问和操作 MCP 服务器的功能，同时保持与现有 MCP 协议的完全兼容性。

## 2. 功能需求

### 2.1 SSE 传输认证机制

**用户故事**: 作为系统管理员，我希望 SSE 传输模式下的所有连接都需要 API 密钥验证，以便防止未经授权的访问和操作。

**验收标准**:
1. **当** AI 智能体尝试通过 SSE 连接到 MCP 服务器时，**则** 系统**必须**验证 HTTP Authorization 头中的 Bearer token
2. **当** Authorization 头缺失时，**则** 系统**必须**返回 HTTP 401 未授权错误
3. **当** 提供的 API 密钥无效时，**则** 系统**必须**返回 HTTP 401 未授权错误并记录尝试
4. **当** API 密钥有效时，**则** 系统**必须**允许建立 MCP 连接并开始协议握手
5. **当** 连接建立后，**则** 系统**应该**定期验证连接的有效性以防止会话劫持

### 2.2 Stdio 传输认证增强

**用户故事**: 作为系统管理员，我希望 Stdio 传输模式也支持可选的 API 密钥认证，以便在需要时提供额外的安全保障。

**验收标准**:
1. **当** 智能体通过环境变量 `MCP_AGENT_KEY` 提供 API 密钥时，**则** 系统**必须**验证该密钥的有效性
2. **当** 环境变量中的 API 密钥无效时，**则** 系统**必须**拒绝启动并显示认证错误
3. **当** 未提供环境变量时，**则** 系统**可以**根据配置决定是否允许连接（向后兼容）
4. **当** 启用 Stdio 认证时，**则** 系统**必须**在启动时验证 API 密钥而不是每次请求时验证

### 2.3 API 密钥管理

**用户故事**: 作为系统管理员，我希望能够安全地管理和配置多个 API 密钥，以便控制不同智能体的访问权限和身份识别。

**验收标准**:
1. **当** 系统启动时，**则** 系统**必须**支持从配置文件和环境变量两种方式加载 API 密钥
2. **当** 使用配置文件时，**则** 系统**必须**支持多个智能体的独立 API 密钥配置
3. **当** 使用环境变量时，**则** 系统**必须**支持向后兼容的单一 `AGENT_API_KEY` 配置
4. **当** API 密钥为空或未设置时，**则** 系统**必须**显示配置错误并拒绝启动
5. **当** 验证 API 密钥时，**则** 系统**必须**使用安全的字符串比较以防止时序攻击
6. **当** 多个 API 密钥配置时，**则** 系统**必须**确保所有密钥的唯一性
7. **当** 密钥长度不足时，**则** 系统**应该**在启动时发出安全警告
8. **当** 系统运行时，**则** API 密钥**绝不**应该出现在日志或错误消息中

### 2.3.1 多密钥配置优先级

**用户故事**: 作为系统管理员，我希望系统能够优雅地处理配置文件和环境变量的优先级，以便支持不同的部署场景。

**验收标准**:
1. **当** 同时存在配置文件和环境变量时，**则** 系统**应该**优先使用配置文件中的设置
2. **当** 配置文件加载失败时，**则** 系统**应该**回退到环境变量配置
3. **当** 两种配置都不可用时，**则** 系统**必须**提供清晰的配置指导信息
4. **当** 配置冲突时，**则** 系统**必须**记录警告并说明所使用的配置源
5. **当** 迁移配置时，**则** 系统**应该**提供配置转换和验证工具

### 2.4 基于中间件的工具级访问控制

**用户故事**: 作为系统管理员，我希望能够通过 FastMCP 中间件系统基于智能体身份控制对不同 MCP 工具的访问权限，以便实现细粒度的权限管理。

**验收标准**:
1. **当** 智能体调用工具时，**则** 系统**必须**通过自定义 `Middleware` 类的 `on_call_tool` 钩子进行权限验证
2. **当** 智能体调用 `submit_article` 工具时，**则** 权限中间件**必须**验证该智能体具有 "article:submit" 范围
3. **当** 智能体调用 `approve_article` 或 `reject_article` 工具时，**则** 权限中间件**必须**验证该智能体具有 "article:review" 范围
4. **当** 权限验证失败时，**则** 系统**必须**抛出 `ToolError` 异常并包含权限要求说明
5. **当** 获取访问令牌信息时，**则** 系统**必须**使用 FastMCP 的 `get_access_token()` 依赖注入函数

### 2.4.1 中间件权限检查实现

**用户故事**: 作为开发者，我希望能够使用标准的 FastMCP 中间件模式实现权限检查逻辑。

**验收标准**:
1. **当** 实现权限中间件时，**则** 系统**必须**继承 FastMCP 的 `Middleware` 基类
2. **当** 检查工具权限时，**则** 中间件**必须**从 `AccessToken.scopes` 中验证所需范围
3. **当** 访问被拒绝时，**则** 系统**必须**使用 FastMCP 标准的错误处理模式
4. **当** 记录权限检查结果时，**则** 系统**必须**记录智能体 ID (`AccessToken.client_id`) 和请求的工具名称

### 2.5 认证事件审计

**用户故事**: 作为安全管理员，我希望系统记录所有认证相关的事件，以便进行安全审计和异常检测。

**验收标准**:
1. **当** 智能体成功认证时，**则** 系统**必须**记录认证成功事件，包括时间戳和传输方式
2. **当** 智能体认证失败时，**则** 系统**必须**记录失败事件，包括失败原因和来源信息
3. **当** 检测到多次认证失败时，**则** 系统**应该**记录潜在的安全威胁警告
4. **当** 智能体连接断开时，**则** 系统**必须**记录会话结束事件
5. **当** 记录审计日志时，**则** 系统**绝不**应该记录敏感的认证凭据

### 2.6 连接限流和保护

**用户故事**: 作为系统管理员，我希望系统能够防止暴力破解攻击和滥用，以便保护服务器资源和安全。

**验收标准**:
1. **当** 来自同一来源的认证失败次数超过阈值时，**则** 系统**必须**临时阻止该来源的连接尝试
2. **当** 在短时间内收到大量连接请求时，**则** 系统**应该**实施连接速率限制
3. **当** 检测到异常连接模式时，**则** 系统**应该**记录安全警告并可选择性地阻止连接
4. **当** 阻止期过后，**则** 系统**必须**允许被阻止的来源重新尝试认证
5. **当** 配置限流参数时，**则** 系统**应该**支持通过环境变量调整阈值和时间窗口

### 2.7 个人使用场景的多智能体架构

**用户故事**: 作为个人用户，我希望系统能够支持多个AI智能体协作完成内容创作工作流，每个智能体专注于不同的任务如写作、SEO优化、审校等。

**验收标准**:
1. **当** 设计多智能体架构时，**则** 系统**必须**支持5-10个智能体的并发连接（满足个人使用需求）
2. **当** 智能体执行任务时，**则** 系统**必须**能够识别和追踪每个智能体的专业角色
3. **当** 智能体协作时，**则** 系统**应该**支持并列工作模式而不是串行工作流
4. **当** 记录操作历史时，**则** 系统**必须**关联每个操作到具体的智能体身份
5. **当** 扩展智能体数量时，**则** 系统**不应该**需要重新配置核心架构

### 2.7.1 智能体角色和专业化

**用户故事**: 作为内容创作者，我希望不同的智能体能够专注于不同的内容优化任务，以便提高整体内容质量和创作效率。

**验收标准**:
1. **当** 配置智能体时，**则** 系统**应该**支持为每个智能体设置描述性标签和角色说明
2. **当** 智能体提交内容时，**则** 系统**应该**能够识别提交智能体的专业领域
3. **当** 查看内容历史时，**则** 系统**必须**显示参与创作和优化的智能体信息
4. **当** 智能体执行操作时，**则** 系统**不应该**限制智能体的工具访问权限
5. **当** 分析内容质量时，**则** 系统**应该**支持按智能体角色统计贡献

### 2.8 FastMCP 兼容的环境变量配置

**用户故事**: 作为部署工程师，我希望能够使用 FastMCP 标准的环境变量配置认证相关的参数，以便与 FastMCP 生态系统保持一致。

**验收标准**:
1. **当** 配置认证模式时，**则** 系统**必须**支持 `FASTMCP_SERVER_AUTH=JWT` 环境变量
2. **当** 配置 JWT 验证时，**则** 系统**必须**支持 `FASTMCP_SERVER_AUTH_JWT_JWKS_URI` 和相关 JWT 配置变量
3. **当** 使用自定义 API 密钥时，**则** 系统**应该**同时支持 `AGENT_API_KEY` (向后兼容) 和 FastMCP 标准变量
4. **当** 配置认证提供者时，**则** 系统**必须**支持通过 `EnvBearerAuthProvider` 从环境变量自动加载配置
5. **当** 环境变量配置不完整时，**则** 系统**必须**在启动时提供 FastMCP 标准的错误诊断信息

### 2.8.1 环境变量优先级和兼容性

**用户故事**: 作为系统维护者，我希望新的 FastMCP 环境变量能够与现有配置共存，以便平滑迁移。

**验收标准**:
1. **当** 同时设置了 FastMCP 标准变量和自定义变量时，**则** 系统**应该**优先使用 FastMCP 标准变量
2. **当** 只设置了传统的 `AGENT_API_KEY` 时，**则** 系统**必须**仍然能够正常工作（向后兼容）
3. **当** 迁移到 FastMCP 标准配置时，**则** 系统**应该**在日志中提供迁移指导建议
4. **当** 配置验证失败时，**则** 系统**必须**明确指出是 FastMCP 标准配置还是自定义配置的问题

### 2.9 向后兼容性

**用户故事**: 作为现有用户，我希望升级到 v2.1 后现有的集成仍然能够正常工作，以便平滑地迁移到新的多智能体和多站点功能。

**验收标准**:
1. **当** 未配置多智能体设置时，**则** 系统**必须**支持传统的单一 `AGENT_API_KEY` 环境变量配置
2. **当** 未配置多站点设置时，**则** 系统**必须**使用现有的单一WordPress站点环境变量配置
3. **当** 启用兼容模式时，**则** 系统**必须**在日志中明确标记使用的配置模式
4. **当** 使用旧版本客户端时，**则** 系统**应该**提供清晰的功能升级指导信息
5. **当** 迁移到多智能体模式时，**则** 系统**必须**提供配置转换工具和迁移文档
6. **当** 部署新版本时，**则** 系统**应该**支持分阶段启用新功能而不破坏现有工作流

### 2.9.1 配置迁移和转换

**用户故事**: 作为系统管理员，我希望能够轻松地将现有的单智能体配置迁移到多智能体配置，以便逐步扩展系统能力。

**验收标准**:
1. **当** 检测到传统配置时，**则** 系统**应该**提供自动转换为新配置格式的选项
2. **当** 执行配置转换时，**则** 系统**必须**保留现有的所有功能设置
3. **当** 转换完成后，**则** 系统**必须**验证新配置的正确性和完整性
4. **当** 转换失败时，**则** 系统**必须**回退到原始配置并提供详细的错误信息
5. **当** 提供迁移工具时，**则** 系统**应该**包含配置预览和回滚功能

### 2.10 错误处理和用户体验

**用户故事**: 作为开发者，我希望认证错误能够提供清晰的错误信息和解决建议，以便快速诊断和解决认证问题。

**验收标准**:
1. **当** API 密钥格式错误时，**则** 系统**必须**返回具体的格式要求说明
2. **当** 智能体权限不足时，**则** 系统**必须**明确指出所需的权限级别
3. **当** 认证服务不可用时，**则** 系统**必须**提供服务状态信息和重试建议
4. **当** 配置错误导致认证失败时，**则** 系统**必须**提供配置检查和修复指导
5. **当** 发生认证错误时，**则** 错误响应**必须**符合 MCP 协议的错误格式规范

### 2.11 FastMCP 认证架构集成

**用户故事**: 作为系统架构师，我需要利用 FastMCP 的内置认证系统来实现安全的 API 密钥验证，以便与现有框架无缝集成。

**验收标准**:
1. **当** 配置认证提供者时，**则** 系统**必须**使用 FastMCP 的 `BearerAuthProvider` 类进行 API 密钥验证
2. **当** 验证 JWT 令牌时，**则** 系统**应该**支持 JWKS URI 配置以获得自动密钥轮换能力
3. **当** 实现工具级授权时，**则** 系统**必须**使用 FastMCP 的 `on_call_tool` 中间件钩子
4. **当** 处理认证错误时，**则** 系统**必须**使用 FastMCP 兼容的 `ToolError` 和错误响应格式
5. **当** 添加认证中间件时，**则** 系统**必须**使用 `mcp.add_middleware()` 方法进行集成

### 2.11.1 认证提供者配置

**用户故事**: 作为系统管理员，我希望能够使用 FastMCP 的标准认证提供者配置 API 密钥验证。

**验收标准**:
1. **当** 配置静态 API 密钥验证时，**则** 系统**必须**支持通过 `BearerAuthProvider` 的公钥配置
2. **当** 使用环境变量配置时，**则** 系统**必须**支持 `EnvBearerAuthProvider` 类
3. **当** 初始化 FastMCP 服务器时，**则** 系统**必须**将认证提供者传递给 `FastMCP(auth=auth_provider)` 构造函数
4. **当** 认证提供者未正确配置时，**则** 系统**必须**在启动时报告配置错误

### 2.12 会话管理和安全强化

**用户故事**: 作为安全工程师，我希望系统具有完善的会话管理和安全强化机制，以便防止会话劫持和凭据泄露。

**验收标准**:
1. **当** 建立 SSE 连接时，**则** 系统**必须**实施会话超时机制（默认30分钟）
2. **当** 检测到异常活动时，**则** 系统**必须**能够主动终止可疑会话
3. **当** 系统出错时，**则** API 密钥**绝不**应该出现在堆栈跟踪或调试输出中
4. **当** 生产环境运行时，**则** 系统**必须**强制使用 HTTPS 传输
5. **当** 存储 API 密钥时，**则** 系统**必须**使用安全的内存管理避免密钥泄露

### 2.13 API 密钥强度和轮换

**用户故事**: 作为安全管理员，我希望系统支持安全的 API 密钥管理，包括强度验证和轮换机制。

**验收标准**:
1. **当** 配置 API 密钥时，**则** 系统**必须**验证密钥至少包含 32 个字符且具有足够熵
2. **当** 检测到弱密钥时，**则** 系统**必须**拒绝启动并提供密钥强度要求说明
3. **当** 实施密钥轮换时，**则** 系统**应该**支持优雅的密钥过渡而不中断服务
4. **当** 多个密钥同时有效时，**则** 系统**必须**能够识别和记录使用的具体密钥
5. **当** 密钥即将过期时，**则** 系统**应该**提前记录警告日志

### 2.14 健康检查和监控集成

**用户故事**: 作为运维工程师，我希望系统提供不需要认证的健康检查端点，以便监控系统状态而不暴露认证凭据。

**验收标准**:
1. **当** 监控系统检查服务状态时，**则** 健康检查端点**必须**绕过认证要求
2. **当** 提供系统状态时，**则** 健康检查**必须**包含认证服务的可用性状态
3. **当** 系统过载时，**则** 健康检查**应该**报告认证服务的性能指标
4. **当** 记录健康检查访问时，**则** 系统**不应该**记录敏感的认证信息
5. **当** 外部监控集成时，**则** 健康检查接口**必须**与现有监控系统兼容

### 2.15 多智能体API密钥管理

**用户故事**: 作为个人用户，我希望系统能够支持多个AI智能体同时连接，每个智能体使用独立的API密钥，以便实现多智能体并列协作的内容创作工作流。

**验收标准**:
1. **当** 配置多个智能体时，**则** 系统**必须**支持通过 `agents.yml` 配置文件定义智能体信息
2. **当** 智能体连接到MCP服务器时，**则** 系统**必须**能够识别和验证智能体的唯一身份
3. **当** 多个智能体同时连接时，**则** 系统**必须**支持至少5-10个并发智能体连接
4. **当** 智能体执行操作时，**则** 系统**必须**记录操作与特定智能体的关联关系
5. **当** 智能体API密钥无效时，**则** 系统**必须**拒绝连接并记录失败的智能体身份

### 2.15.1 智能体配置文件管理

**用户故事**: 作为系统管理员，我希望能够通过配置文件管理多个智能体的认证和权限信息，以便灵活配置智能体协作环境。

**验收标准**:
1. **当** 定义智能体配置时，**则** `agents.yml` 文件**必须**支持智能体ID、API密钥、描述和权限范围的配置
2. **当** 修改智能体配置时，**则** 系统**应该**支持配置文件的热重载而无需重启服务
3. **当** 配置文件格式错误时，**则** 系统**必须**在启动时提供详细的配置验证错误信息
4. **当** 智能体配置冲突时，**则** 系统**必须**检测并报告重复的智能体ID或API密钥
5. **当** 加载配置文件时，**则** 系统**必须**验证所有必需字段的完整性和格式正确性

### 2.16 多WordPress站点支持

**用户故事**: 作为个人博主，我希望一个MCP服务器实例能够管理我的多个WordPress站点，以便统一管理不同主题的内容发布需求。

**验收标准**:
1. **当** 配置多个WordPress站点时，**则** 系统**必须**支持通过 `sites.yml` 配置文件定义站点连接信息
2. **当** 智能体提交文章时，**则** 系统**必须**允许指定目标发布站点
3. **当** 发布文章到特定站点时，**则** 系统**必须**使用对应站点的WordPress API凭据
4. **当** 某个站点连接失败时，**则** 系统**必须**隔离故障，不影响其他站点的正常发布
5. **当** 系统启动时，**则** 系统**应该**验证所有配置站点的连接可用性

### 2.16.1 站点配置和连接管理

**用户故事**: 作为系统管理员，我希望能够灵活配置和管理多个WordPress站点的连接参数，以便支持不同站点的特定需求。

**验收标准**:
1. **当** 定义站点配置时，**则** `sites.yml` 文件**必须**支持API URL、用户名、应用密码、默认分类等参数
2. **当** 站点配置更新时，**则** 系统**应该**支持动态重载站点配置而无需重启
3. **当** 站点连接测试时，**则** 系统**必须**提供独立的连接健康检查功能
4. **当** 站点认证失败时，**则** 系统**必须**记录具体的站点标识和失败原因
5. **当** 管理站点连接池时，**则** 系统**必须**为每个站点维护独立的HTTP连接池

### 2.17 文章智能体关联和站点路由

**用户故事**: 作为内容管理者，我希望系统能够追踪每篇文章的提交智能体和目标发布站点，以便进行内容来源管理和发布状态跟踪。

**验收标准**:
1. **当** 智能体提交文章时，**则** 系统**必须**自动记录提交智能体的身份信息
2. **当** 指定发布站点时，**则** 系统**必须**验证目标站点的有效性和可用性
3. **当** 查询文章状态时，**则** 系统**必须**显示文章的提交智能体和目标站点信息
4. **当** 发布文章时，**则** 系统**必须**根据目标站点路由到正确的WordPress实例
5. **当** 文章发布成功时，**则** 系统**必须**记录发布的站点标识和WordPress文章ID

### 2.18 配置文件管理系统

**用户故事**: 作为系统管理员，我希望系统提供统一的配置文件管理机制，支持YAML格式配置和环境变量的灵活组合，以便简化多智能体和多站点的配置管理。

**验收标准**:
1. **当** 系统启动时，**则** 系统**必须**支持从指定目录加载 `agents.yml` 和 `sites.yml` 配置文件
2. **当** 配置文件不存在时，**则** 系统**应该**回退到环境变量配置以保持向后兼容
3. **当** 配置文件和环境变量同时存在时，**则** 系统**应该**优先使用配置文件中的设置
4. **当** 配置文件格式错误时，**则** 系统**必须**提供详细的YAML解析错误信息和修复建议
5. **当** 运行时修改配置文件时，**则** 系统**应该**支持配置热重载机制

### 2.18.1 配置验证和错误处理

**用户故事**: 作为开发者，我希望配置系统提供全面的验证和错误处理机制，以便快速识别和修复配置问题。

**验收标准**:
1. **当** 验证智能体配置时，**则** 系统**必须**检查API密钥的强度和唯一性
2. **当** 验证站点配置时，**则** 系统**必须**验证WordPress API URL的可达性和有效性
3. **当** 配置依赖关系错误时，**则** 系统**必须**检测并报告配置间的依赖冲突
4. **当** 配置更新时，**则** 系统**应该**进行增量验证而不是全量重启
5. **当** 配置验证失败时，**则** 系统**必须**提供具体的错误位置和修复建议

### 2.19 简化权限模型

**用户故事**: 作为个人用户，我希望权限模型保持简单易用，所有智能体具有相同的基础权限，角色分工在智能体端实现，以便降低系统配置复杂度。

**验收标准**:
1. **当** 智能体连接到系统时，**则** 所有智能体**必须**具有相同的基础工具访问权限
2. **当** 执行工具权限检查时，**则** 系统**应该**只验证智能体身份而不区分权限等级
3. **当** 智能体调用工具时，**则** 系统**不应该**基于智能体身份限制特定工具的访问
4. **当** 记录操作日志时，**则** 系统**必须**记录操作的智能体身份以支持审计追踪
5. **当** 配置权限策略时，**则** 系统**应该**支持全局权限开关而不是细粒度权限控制

## 3. 非功能需求

### 3.1 性能要求

- 认证验证不应增加超过 10ms 的请求延迟
- 系统应支持至少 5-10 个并发智能体连接（个人使用场景）
- 系统应支持 3-5 个WordPress站点的同时管理
- 多站点发布操作应在 60 秒内完成
- 配置文件加载和验证应在 5 秒内完成
- 限流机制不应影响正常用户的使用体验

### 3.2 安全要求

- 每个智能体的 API 密钥必须支持至少 32 字符的长度
- 所有认证失败尝试都必须被记录和监控
- 系统不应在任何输出中暴露 API 密钥
- 多站点的WordPress凭据必须安全存储和传输
- 智能体身份信息必须在操作日志中完整记录

### 3.3 可用性要求

- 认证错误消息必须对非技术用户友好
- 系统启动时必须验证所有认证、智能体和站点配置
- 必须提供多智能体状态检查的管理接口
- 配置文件错误必须提供精确的行号和修复建议
- 站点连接状态必须实时可查询

### 3.4 扩展性要求

- 系统架构必须支持从1个智能体扩展到10个智能体
- 系统必须支持从1个WordPress站点扩展到5个站点
- 配置文件大小不应影响系统启动性能
- 数据库表结构必须支持智能体和站点信息的存储扩展

### 3.5 兼容性要求

- 必须保持与现有单智能体配置的完全向后兼容
- 必须保持与现有单站点配置的完全向后兼容
- 必须支持从v2.0配置的无缝升级路径
- 必须保持与现有MCP客户端的协议兼容性